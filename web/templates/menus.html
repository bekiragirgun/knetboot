{% extends "base.html" %}

{% block title %}iPXE Menus - Kapadokya NetBoot{% endblock %}

{% block page_title %}
    <i class="ti ti-list me-2"></i>iPXE Menus
{% endblock %}

{% block page_actions %}
<div class="col-auto ms-auto d-print-none">
    <button class="btn btn-success" onclick="regenerateMenus()">
        <i class="ti ti-reload me-2"></i>
        Regenerate Menus
    </button>
</div>
{% endblock %}

{% block content %}
{% if menu_files %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Generated Menu Files ({{ menu_files|length }})</h3>
                <div class="card-actions">
                    <span class="text-secondary">
                        <i class="ti ti-info-circle me-1"></i>
                        Auto-generated from images.yaml
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for menu in menu_files %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="avatar bg-primary-lt">
                                    <i class="ti ti-file-code"></i>
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-reset d-block"><code>{{ menu }}</code></div>
                                <div class="text-secondary text-truncate mt-n1">
                                    iPXE menu script
                                </div>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-azure-lt me-2">iPXE</span>
                            </div>
                            <div class="col-auto">
                                <div class="btn-list">
                                    <button class="btn btn-sm btn-icon btn-primary" onclick="viewMenu('{{ menu }}')" title="Preview">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                    <a href="{{ url_for('edit_menu', filename=menu) }}" class="btn btn-sm btn-icon btn-warning" title="Edit">
                                        <i class="ti ti-edit"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-file-x"></i>
                    </div>
                    <p class="empty-title">No menu files found</p>
                    <p class="empty-subtitle text-secondary">
                        Generate menus from <code>images.yaml</code> configuration
                    </p>
                    <div class="empty-action">
                        <button class="btn btn-success" onclick="regenerateMenus()">
                            <i class="ti ti-reload me-2"></i>
                            Generate Menus Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Menu Preview Modal -->
<div class="modal modal-blur fade" id="menuModal" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="menuModalTitle">Menu Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="menuContent" class="bg-dark text-white p-3" style="max-height: 500px; overflow-y: auto;"><code></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewMenu(menuName) {
    showLoading('Loading menu...');

    fetch('/api/menus/view/' + menuName)
        .then(r => r.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                document.getElementById('menuModalTitle').textContent = menuName;
                document.getElementById('menuContent').textContent = data.content;

                const modal = new bootstrap.Modal(document.getElementById('menuModal'));
                modal.show();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        })
        .catch(e => {
            hideLoading();
            showToast('Error: ' + e, 'error');
        });
}
</script>
{% endblock %}
