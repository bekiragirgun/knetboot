{% extends "base.html" %}

{% block title %}DHCP Configuration{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1>‚öôÔ∏è DHCP Configuration</h1>
    <div class="dhcp-service-toggle">
        <label class="switch">
            <input type="checkbox" id="dhcpServiceToggle" {% if dhcp_enabled %}checked{% endif %} onchange="toggleDHCPService(this)">
            <span class="slider"></span>
        </label>
        <span class="ms-2 service-label" id="serviceStatus">
            {% if dhcp_enabled %}
                <span class="badge bg-success">DHCP ON</span>
            {% else %}
                <span class="badge bg-danger">DHCP OFF</span>
            {% endif %}
        </span>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                {{ message }}
                <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Current Configuration</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Network:</strong> <code>{{ config.network }}/{{ config.netmask }}</code></p>
                <p><strong>DHCP Range:</strong> <code>{{ config.range_start }} - {{ config.range_end }}</code></p>
                <p><strong>Gateway:</strong> <code>{{ config.gateway }}</code></p>
            </div>
            <div class="col-md-6">
                <p><strong>DNS Servers:</strong> <code>{{ config.dns }}</code></p>
                <p><strong>PXE Server:</strong> <code>{{ config.next_server }}</code></p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Edit DHCP Settings</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('dhcp_update') }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="network">Network Address</label>
                        <input type="text" class="form-control" id="network" name="network"
                               value="{{ config.network }}" required pattern="(\d{1,3}\.){3}\d{1,3}">
                        <small class="form-text text-muted">Example: 192.168.122.0</small>
                    </div>

                    <div class="form-group">
                        <label for="netmask">Netmask</label>
                        <input type="text" class="form-control" id="netmask" name="netmask"
                               value="{{ config.netmask }}" required pattern="(\d{1,3}\.){3}\d{1,3}">
                        <small class="form-text text-muted">Example: 255.255.255.0</small>
                    </div>

                    <div class="form-group">
                        <label for="range_start">DHCP Range Start</label>
                        <input type="text" class="form-control" id="range_start" name="range_start"
                               value="{{ config.range_start }}" required pattern="(\d{1,3}\.){3}\d{1,3}">
                        <small class="form-text text-muted">First IP in DHCP pool</small>
                    </div>

                    <div class="form-group">
                        <label for="range_end">DHCP Range End</label>
                        <input type="text" class="form-control" id="range_end" name="range_end"
                               value="{{ config.range_end }}" required pattern="(\d{1,3}\.){3}\d{1,3}">
                        <small class="form-text text-muted">Last IP in DHCP pool</small>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="gateway">Gateway (Router)</label>
                        <input type="text" class="form-control" id="gateway" name="gateway"
                               value="{{ config.gateway }}" required pattern="(\d{1,3}\.){3}\d{1,3}">
                        <small class="form-text text-muted">Network gateway IP</small>
                    </div>

                    <div class="form-group">
                        <label for="dns">DNS Servers</label>
                        <input type="text" class="form-control" id="dns" name="dns"
                               value="{{ config.dns }}" required>
                        <small class="form-text text-muted">Comma-separated (e.g., 192.168.122.1, 8.8.8.8)</small>
                    </div>

                    <div class="form-group">
                        <label for="next_server">PXE Server IP (next-server)</label>
                        <input type="text" class="form-control" id="next_server" name="next_server"
                               value="{{ config.next_server }}" required pattern="(\d{1,3}\.){3}\d{1,3}">
                        <small class="form-text text-muted">TFTP/PXE boot server IP</small>
                    </div>

                    <div class="alert alert-info">
                        <strong>Note:</strong> Changes will be saved immediately. You need to restart the DHCP service for changes to take effect.
                    </div>
                </div>
            </div>

            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                <a href="{{ url_for('dhcp_restart') }}" class="btn btn-warning ml-2"
                   onclick="return confirm('Are you sure you want to restart the DHCP server?')">
                    üîÑ Restart DHCP Service
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary ml-2">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
.alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    position: relative;
}
.alert-success {
    background-color: #d4edda;
    border-left: 4px solid #28a745;
    color: #155724;
}
.alert-danger {
    background-color: #f8d7da;
    border-left: 4px solid #dc3545;
    color: #721c24;
}
.alert-info {
    background-color: #d1ecf1;
    border-left: 4px solid #17a2b8;
    color: #0c5460;
}
.alert .close {
    position: absolute;
    top: 10px;
    right: 15px;
    border: none;
    background: none;
    font-size: 20px;
    cursor: pointer;
    opacity: 0.5;
}
.alert .close:hover {
    opacity: 1;
}

/* Toggle Switch Styles */
.dhcp-service-toggle {
    display: flex;
    align-items: center;
}

.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #dc3545;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #28a745;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.page-header {
    margin-bottom: 20px;
}
</style>

<script>
function toggleDHCPService(checkbox) {
    const isEnabled = checkbox.checked;
    const action = isEnabled ? 'start' : 'stop';
    const statusLabel = document.getElementById('serviceStatus');

    if (!confirm(`Are you sure you want to ${action.toUpperCase()} the DHCP server?`)) {
        checkbox.checked = !isEnabled;
        return;
    }

    // Disable toggle while processing
    checkbox.disabled = true;

    fetch(`{{ url_for('dhcp_toggle') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ enable: isEnabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status badge
            if (isEnabled) {
                statusLabel.innerHTML = '<span class="badge bg-success">DHCP ON</span>';
            } else {
                statusLabel.innerHTML = '<span class="badge bg-danger">DHCP OFF</span>';
            }
            // Show success message
            showAlert('success', data.message);
        } else {
            // Revert toggle on error
            checkbox.checked = !isEnabled;
            showAlert('danger', 'Error: ' + data.error);
        }
    })
    .catch(error => {
        // Revert toggle on error
        checkbox.checked = !isEnabled;
        showAlert('danger', 'Error: ' + error);
    })
    .finally(() => {
        checkbox.disabled = false;
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
    `;

    const container = document.querySelector('.page-header');
    container.parentNode.insertBefore(alertDiv, container.nextSibling);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
