{% extends "base.html" %}

{% block title %}TFTP Configuration - Kapadokya NetBoot{% endblock %}

{% block page_title %}
    <i class="ti ti-network me-2"></i>TFTP Configuration
{% endblock %}

{% block page_actions %}
<div class="col-auto ms-auto d-print-none">
    <div class="d-flex align-items-center">
        <span class="me-3">
            <span class="status-indicator {% if tftp_enabled %}active{% else %}inactive{% endif %}" data-service="tftp"></span>
            <span class="fw-bold">{% if tftp_enabled %}Active{% else %}Inactive{% endif %}</span>
        </span>
        <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" {% if tftp_enabled %}checked{% endif %} onchange="toggleService('tftp', this)">
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row row-deck row-cards">
    <!-- TFTP Settings -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-settings me-2"></i>
                    TFTP Server Settings
                </h3>
                <div class="card-actions">
                    <a href="{{ url_for('tftp_restart') }}" class="btn btn-primary btn-sm" onclick="return confirm('Restart TFTP server?')">
                        <i class="ti ti-reload me-2"></i>
                        Restart
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('tftp_update') }}">
                    <div class="mb-3">
                        <label class="form-label required">TFTP Root Directory</label>
                        <input type="text" class="form-control" name="tftp_root" value="{{ config.tftp_root }}" required>
                        <small class="form-hint">Directory where boot files are served from</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Listen Address</label>
                        <input type="text" class="form-control" name="tftp_address" value="{{ config.tftp_address }}" placeholder="0.0.0.0">
                        <small class="form-hint">IP address to listen on (0.0.0.0 for all interfaces)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Options</label>
                        <input type="text" class="form-control" name="tftp_options" value="{{ config.tftp_options }}">
                        <small class="form-hint">Additional TFTP options (e.g., --secure --verbose)</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="ti ti-device-floppy me-2"></i>
                        Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Upload Boot File -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-upload me-2"></i>
                    Upload Boot File
                </h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('tftp_upload') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Select Boot File</label>
                        <input type="file" class="form-control" name="boot_file" accept=".kpxe,.efi,.pxe,.0,.bin" required>
                        <small class="form-hint">Allowed: .kpxe, .efi, .pxe, .0, .bin (max 10MB)</small>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="ti ti-upload me-2"></i>
                        Upload File
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Boot Files List -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-files me-2"></i>
                    Boot Files ({{ boot_files|length }})
                </h3>
            </div>
            <div class="card-body p-0">
                {% if boot_files %}
                <div class="table-responsive">
                    <table class="table table-vcenter card-table">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>TFTP URL</th>
                                <th>HTTP URL</th>
                                <th class="w-1">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in boot_files %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if file.type == 'bios' %}
                                            <span class="avatar avatar-sm bg-primary-lt me-2">
                                                <i class="ti ti-device-desktop"></i>
                                            </span>
                                        {% elif file.type == 'uefi' %}
                                            <span class="avatar avatar-sm bg-info-lt me-2">
                                                <i class="ti ti-cpu"></i>
                                            </span>
                                        {% else %}
                                            <span class="avatar avatar-sm bg-secondary-lt me-2">
                                                <i class="ti ti-file"></i>
                                            </span>
                                        {% endif %}
                                        <code>{{ file.name }}</code>
                                    </div>
                                </td>
                                <td>
                                    {% if file.type == 'bios' %}
                                        <span class="badge bg-primary">BIOS</span>
                                    {% elif file.type == 'uefi' %}
                                        <span class="badge bg-info">UEFI</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Other</span>
                                    {% endif %}
                                </td>
                                <td>{{ file.size }}</td>
                                <td><code class="text-muted small">tftp://{{ config.tftp_address.split(':')[0] if ':' in config.tftp_address else config.tftp_address }}/{{ file.name }}</code></td>
                                <td><code class="text-success small">http://SERVER_IP/boot/http/{{ file.name }}</code></td>
                                <td>
                                    <form method="POST" action="{{ url_for('tftp_delete_file', filename=file.name) }}" style="display:inline;" onsubmit="return confirm('Delete {{ file.name }}?')">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-file-x"></i>
                    </div>
                    <p class="empty-title">No boot files found</p>
                    <p class="empty-subtitle text-secondary">Upload .kpxe or .efi files to get started</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
