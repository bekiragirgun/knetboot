#cloud-config
# Ubuntu 24.04 LTS Server - Autoinstall Configuration
# Cloud-init autoinstall file for unattended installation
# Documentation: https://canonical-subiquity.readthedocs-hosted.com/en/latest/reference/autoinstall-reference.html

autoinstall:
  version: 1

  # Refresh installer to latest version
  refresh-installer:
    update: true
    channel: latest/edge

  # APT configuration
  apt:
    disable_components: []
    fallback: abort
    geoip: true
    mirror-selection:
      primary:
      - country-mirror
      - arches: &id001
        - amd64
        - i386
        uri: http://archive.ubuntu.com/ubuntu/
      - arches: &id002
        - arm64
        - armhf
        - powerpc
        - ppc64el
        - riscv64
        uri: http://ports.ubuntu.com/ubuntu-ports
    preserve_sources_list: false
    security:
    - arches: *id001
      uri: http://security.ubuntu.com/ubuntu/
    - arches: *id002
      uri: http://ports.ubuntu.com/ubuntu-ports

  # Additional packages to install
  packages:
    - git
    - curl
    - wget
    - vim
    - nano
    - htop
    - net-tools
    - build-essential
    - openssh-server

  # Automatically install hardware drivers
  drivers:
    install: true

  # Storage configuration - LVM with auto-sizing
  storage:
    layout:
      name: lvm
      sizing-policy: all

  # Disable root login (security best practice)
  user-data:
    disable_root: false

  # System identity
  identity:
    realname: 'Ubuntu Server Admin'
    hostname: ubuntu-server
    username: ubuntu
    # Default password: ubuntu (change after first login!)
    # Generated with: openssl passwd -6 -salt xyz ubuntu
    password: '$6$xyz$rjarwc/BNZnhWb1I1E1IcXJ2gZk0V3vXR3Cl2rKj1LjMrFVZC7WfGvvIbJSJJcUcLhDJMz.9fJQgJDuCE/9Fg0'

  # Kernel selection
  kernel:
    package: linux-generic

  # Keyboard layout
  keyboard:
    layout: us
    toggle: null
    variant: ''

  # Locale settings
  locale: en_US.UTF-8

  # Network configuration
  network:
    version: 2
    ethernets:
        ens33:
            match:
                name: "en*"
            dhcp4: true
        eth0:
            match:
                name: "eth*"
            dhcp4: true

  # OEM installation
  oem:
    install: auto

  # Snap packages
  snaps:
  - channel: stable
    classic: true
    name: powershell

  # Installation source
  source:
    id: ubuntu-server-minimal
    search_drivers: true

  # SSH configuration
  ssh:
    allow-pw: true
    authorized-keys: []
    install-server: true

  # Update policy
  updates: security

  # Timezone
  timezone: Europe/Istanbul

  # Post-installation commands
  late-commands:
    # Update package lists
    - curtin in-target --target /target -- apt update -y
    # Upgrade installed packages
    - curtin in-target --target /target -- apt upgrade -y
    # Distribution upgrade
    - curtin in-target --target /target -- apt-get dist-upgrade -y
    # Clean up unused packages
    - curtin in-target --target /target -- apt autoremove -y
    # Set root password (same as ubuntu user)
    - curtin in-target --target=/target -- sudo usermod -p '$6$xyz$rjarwc/BNZnhWb1I1E1IcXJ2gZk0V3vXR3Cl2rKj1LjMrFVZC7WfGvvIbJSJJcUcLhDJMz.9fJQgJDuCE/9Fg0' root
    # Update GRUB
    - curtin in-target --target=/target -- update-grub2
    # Automatic reboot after installation
    - reboot
